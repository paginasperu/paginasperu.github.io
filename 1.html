<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Licorer√≠a Pro - Cat√°logo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root { --primary: #7c3aed; } /* Color din√°mico */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .modal-active { overflow: hidden; }
        .category-pill.active { background-color: var(--primary); color: white; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 font-sans">

    <script>
        const CONFIG = {
            sheetUrl: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRUcc0qpHG3yPnGv714JJlzLkry_VWsKvIdrPCS-2fIM5oSLPL0a_MmyzUk9eQomrBkplUL5auyxhmV/pub?gid=0&single=true&output=csv",
            businessName: "Licorer√≠a Premium",
            primaryColor: "#b91c1c", // Rojo licorero
            currency: "S/ ",
            whatsapp: "51900000000",
            socials: {
                instagram: "https://instagram.com",
                facebook: "https://facebook.com",
                tiktok: "https://tiktok.com"
            }
        };
        document.documentElement.style.setProperty('--primary', CONFIG.primaryColor);
    </script>

    <header class="sticky top-0 z-40 bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
            <div class="flex items-center gap-2">
                <i data-lucide="wine" class="text-[var(--primary)] w-8 h-8"></i>
                <h1 class="font-bold text-xl hidden sm:block" id="brand-name">Cargando...</h1>
            </div>
            
            <div class="flex-1 relative">
                <input type="text" id="search" placeholder="Buscar etiqueta, marca..." 
                    class="w-full bg-gray-100 border-none rounded-full py-2 px-10 focus:ring-2 focus:ring-[var(--primary)] outline-none transition-all">
                <i data-lucide="search" class="absolute left-3 top-2.5 w-5 h-5 text-gray-400"></i>
            </div>

            <button onclick="toggleCart()" class="relative p-2">
                <i data-lucide="shopping-cart" class="w-7 h-7"></i>
                <span id="cart-count" class="absolute -top-1 -right-1 bg-[var(--primary)] text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full">0</span>
            </button>
        </div>

        <div id="category-bar" class="flex gap-2 px-4 pb-3 overflow-x-auto no-scrollbar scroll-smooth">
            </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-6 min-h-screen">
        <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
            <div class="skeleton h-64 rounded-xl"></div>
            <div class="skeleton h-64 rounded-xl"></div>
            <div class="skeleton h-64 rounded-xl"></div>
            <div class="skeleton h-64 rounded-xl"></div>
        </div>

        <div id="pagination" class="mt-10 flex justify-center gap-4 hidden">
            <button onclick="changePage(-1)" class="px-4 py-2 bg-white border rounded-lg disabled:opacity-50">Anterior</button>
            <span id="page-info" class="self-center font-medium">P√°gina 1</span>
            <button onclick="changePage(1)" class="px-4 py-2 bg-white border rounded-lg disabled:opacity-50">Siguiente</button>
        </div>
    </main>

    <footer class="bg-white border-t mt-12 py-8 px-4 text-center">
        <h2 class="font-bold text-lg mb-4" id="footer-name"></h2>
        <div class="flex justify-center gap-6 mb-6 text-gray-600">
            <a id="ws-link" href="#" target="_blank"><i data-lucide="message-circle"></i></a>
            <a id="ig-link" href="#" target="_blank"><i data-lucide="instagram"></i></a>
            <a id="fb-link" href="#" target="_blank"><i data-lucide="facebook"></i></a>
            <a id="tk-link" href="#" target="_blank"><i data-lucide="music-2"></i></a>
        </div>
        <p class="text-xs text-gray-400">¬© 2024 Cat√°logo Digital Pro. Todos los derechos reservados.</p>
    </footer>

    <div id="product-modal" class="fixed inset-0 z-50 bg-black/50 hidden items-center justify-center p-4 backdrop-blur-sm" onclick="closeModal(event)">
        <div class="bg-white rounded-2xl max-w-lg w-full max-h-[90vh] overflow-y-auto relative" onclick="event.stopPropagation()">
            <button onclick="closeModal()" class="absolute top-4 right-4 p-2 bg-white/80 rounded-full shadow-lg z-10">
                <i data-lucide="x"></i>
            </button>
            <div id="modal-content"></div>
        </div>
    </div>

    <div id="cart-sidebar" class="fixed inset-y-0 right-0 z-50 w-full max-w-md bg-white shadow-2xl transform translate-x-full transition-transform duration-300 flex flex-col">
        <div class="p-4 border-b flex justify-between items-center">
            <h2 class="font-bold text-xl flex items-center gap-2"><i data-lucide="shopping-bag"></i> Tu Carrito</h2>
            <button onclick="toggleCart()"><i data-lucide="x"></i></button>
        </div>
        <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
        <div class="p-6 border-t bg-gray-50">
            <div class="flex justify-between text-xl font-bold mb-4">
                <span>Total:</span>
                <span id="cart-total">S/ 0.00</span>
            </div>
            <button onclick="sendWhatsApp()" class="w-full py-4 bg-green-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-green-700 transition-colors">
                <i data-lucide="send"></i> Enviar Pedido por WhatsApp
            </button>
        </div>
    </div>

    <script>
        let allProducts = [];
        let filteredProducts = [];
        let cart = JSON.parse(localStorage.getItem(`cart_${location.pathname}`)) || [];
        let currentPage = 1;
        const itemsPerPage = 25;
        let activeCategory = 'Todos';

        // --- PARSEO RFC 4180 ---
        function parseCSV(text) {
            const result = [];
            let row = [''];
            let i = 0, quote = false;
            for (let char of text) {
                if (char === '"') {
                    if (quote && text[i+1] === '"') { row[row.length-1] += char; i++; }
                    else quote = !quote;
                } else if (char === ',' && !quote) row.push('');
                else if (char === '\n' && !quote) { result.push(row); row = ['']; }
                else row[row.length-1] += char;
                i++;
            }
            result.push(row);
            return result.slice(1).map(r => ({
                nombre: r[0],
                precio: parseFloat(r[1]) || 0,
                rebajado: parseFloat(r[2]) || 0,
                categoria: r[3],
                descripcion: r[4],
                imagen: r[5]
            })).filter(p => p.nombre);
        }

        // --- GESTI√ìN DE DATOS Y CACH√â ---
        async function loadData() {
            const cacheKey = 'liquor_data';
            const cacheTimeKey = 'liquor_cache_time';
            const cachedData = localStorage.getItem(cacheKey);
            const cacheTime = localStorage.getItem(cacheTimeKey);
            const now = Date.now();

            if (cachedData && cacheTime && (now - cacheTime < 3600000)) {
                allProducts = JSON.parse(cachedData);
                initApp();
            } else {
                try {
                    const response = await fetch(CONFIG.sheetUrl);
                    const text = await response.text();
                    allProducts = parseCSV(text);
                    localStorage.setItem(cacheKey, JSON.stringify(allProducts));
                    localStorage.setItem(cacheTimeKey, now);
                    initApp();
                } catch (e) { console.error("Error cargando datos", e); }
            }
        }

        // --- INICIALIZACI√ìN UI ---
        function initApp() {
            document.getElementById('brand-name').innerText = CONFIG.businessName;
            document.getElementById('footer-name').innerText = CONFIG.businessName;
            document.getElementById('ws-link').href = `https://wa.me/${CONFIG.whatsapp}`;
            document.getElementById('ig-link').href = CONFIG.socials.instagram;
            document.getElementById('fb-link').href = CONFIG.socials.facebook;
            document.getElementById('tk-link').href = CONFIG.socials.tiktok;

            renderCategories();
            filterProducts();
            updateCartUI();
            lucide.createIcons();
        }

        function renderCategories() {
            const cats = ['Todos', ...new Set(allProducts.map(p => p.categoria))];
            const container = document.getElementById('category-bar');
            container.innerHTML = cats.map(c => `
                <button onclick="setCategory('${c}')" class="category-pill whitespace-nowrap px-6 py-2 rounded-full border bg-white text-sm font-medium transition-all ${activeCategory === c ? 'active' : ''}">
                    ${c}
                </button>
            `).join('');
        }

        // --- FILTROS Y B√öSQUEDA ---
        function filterProducts() {
            const query = document.getElementById('search').value.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            
            filteredProducts = allProducts.filter(p => {
                const matchCat = activeCategory === 'Todos' || p.categoria === activeCategory;
                const searchStr = `${p.nombre} ${p.descripcion}`.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                return matchCat && searchStr.includes(query);
            });

            // Ordenar: Rebajados primero
            filteredProducts.sort((a, b) => (b.rebajado > 0) - (a.rebajado > 0));
            
            currentPage = 1;
            renderProducts();
        }

        function renderProducts() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredProducts.slice(start, end);
            
            const grid = document.getElementById('product-grid');
            grid.innerHTML = pageData.map((p, i) => `
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden hover:shadow-md transition-shadow cursor-pointer group" onclick="openModal('${encodeURIComponent(JSON.stringify(p))}')">
                    <div class="aspect-square relative overflow-hidden bg-gray-100">
                        <img src="${p.imagen}" loading="lazy" class="w-full h-full object-cover transform group-hover:scale-105 transition-transform" alt="${p.nombre}">
                        ${p.rebajado > 0 ? `<span class="absolute top-2 left-2 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded">OFERTA</span>` : ''}
                    </div>
                    <div class="p-3">
                        <p class="text-[10px] text-gray-400 uppercase tracking-tighter">${p.categoria}</p>
                        <h3 class="font-bold text-sm line-clamp-1 mb-1">${p.nombre}</h3>
                        <div class="flex items-center gap-2">
                            <span class="text-lg font-black text-[var(--primary)]">${CONFIG.currency}${p.rebajado > 0 ? p.rebajado : p.precio}</span>
                            ${p.rebajado > 0 ? `<span class="text-xs line-through text-gray-400">${CONFIG.currency}${p.precio}</span>` : ''}
                        </div>
                        <button onclick="event.stopPropagation(); addToCart('${encodeURIComponent(JSON.stringify(p))}')" 
                            class="w-full mt-3 py-2 bg-gray-900 text-white text-xs font-bold rounded-lg hover:bg-black transition-colors flex items-center justify-center gap-1">
                            <i data-lucide="plus" class="w-3 h-3"></i> AGREGAR
                        </button>
                    </div>
                </div>
            `).join('');

            document.getElementById('pagination').classList.toggle('hidden', filteredProducts.length <= itemsPerPage);
            document.getElementById('page-info').innerText = `P√°gina ${currentPage}`;
            lucide.createIcons();
        }

        // --- CARRITO ---
        function addToCart(pString) {
            const product = JSON.parse(decodeURIComponent(pString));
            const existing = cart.find(item => item.nombre === product.nombre);
            if (existing) existing.quantity++;
            else cart.push({ ...product, quantity: 1 });
            saveCart();
            updateCartUI();
            toggleCart(true);
        }

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            const totalEl = document.getElementById('cart-total');
            const countEl = document.getElementById('cart-count');
            
            let total = 0;
            let count = 0;

            container.innerHTML = cart.map((item, idx) => {
                const price = item.rebajado > 0 ? item.rebajado : item.precio;
                total += price * item.quantity;
                count += item.quantity;
                return `
                    <div class="flex gap-4 items-center bg-gray-50 p-3 rounded-xl">
                        <img src="${item.imagen}" class="w-16 h-16 object-cover rounded-lg">
                        <div class="flex-1">
                            <h4 class="font-bold text-sm line-clamp-1">${item.nombre}</h4>
                            <p class="text-xs text-gray-500">${CONFIG.currency}${price}</p>
                            <div class="flex items-center gap-3 mt-2">
                                <button onclick="updateQty(${idx}, -1)" class="w-6 h-6 border rounded flex items-center justify-center">-</button>
                                <span class="text-sm font-bold">${item.quantity}</span>
                                <button onclick="updateQty(${idx}, 1)" class="w-6 h-6 border rounded flex items-center justify-center">+</button>
                            </div>
                        </div>
                        <button onclick="removeItem(${idx})" class="text-red-500"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                    </div>
                `;
            }).join('');

            totalEl.innerText = `${CONFIG.currency}${total.toFixed(2)}`;
            countEl.innerText = count;
            lucide.createIcons();
        }

        function updateQty(idx, change) {
            cart[idx].quantity += change;
            if (cart[idx].quantity < 1) cart.splice(idx, 1);
            saveCart();
            updateCartUI();
        }

        function removeItem(idx) {
            cart.splice(idx, 1);
            saveCart();
            updateCartUI();
        }

        function saveCart() {
            localStorage.setItem(`cart_${location.pathname}`, JSON.stringify(cart));
        }

        function toggleCart(forceOpen = false) {
            const sidebar = document.getElementById('cart-sidebar');
            if (forceOpen) sidebar.classList.remove('translate-x-full');
            else sidebar.classList.toggle('translate-x-full');
        }

        function sendWhatsApp() {
            if (cart.length === 0) return alert("Tu carrito est√° vac√≠o");
            
            let total = 0;
            let text = `*üõçÔ∏è NUEVO PEDIDO - ${CONFIG.businessName}*\n`;
            text += `--------------------------------\n`;
            
            cart.forEach(item => {
                const price = item.rebajado > 0 ? item.rebajado : item.precio;
                const subtotal = price * item.quantity;
                total += subtotal;
                text += `‚Ä¢ ${item.quantity}x ${item.nombre} - ${CONFIG.currency}${subtotal.toFixed(2)}\n`;
            });

            text += `--------------------------------\n`;
            text += `*TOTAL A PAGAR: ${CONFIG.currency}${total.toFixed(2)}*\n\n`;
            text += `_Por favor, conf√≠rmame disponibilidad para coordinar la entrega._`;

            const url = `https://wa.me/${CONFIG.whatsapp}?text=${encodeURIComponent(text)}`;
            window.open(url, '_blank');
        }

        // --- MODAL ---
        function openModal(pString) {
            const p = JSON.parse(decodeURIComponent(pString));
            const modal = document.getElementById('product-modal');
            const content = document.getElementById('modal-content');
            
            content.innerHTML = `
                <img src="${p.imagen}" class="w-full aspect-square object-cover">
                <div class="p-6">
                    <span class="text-xs font-bold text-[var(--primary)] uppercase tracking-widest">${p.categoria}</span>
                    <h2 class="text-2xl font-black mt-1 mb-2">${p.nombre}</h2>
                    <p class="text-gray-600 text-sm leading-relaxed mb-6">${p.descripcion}</p>
                    <div class="flex items-center justify-between">
                        <div>
                            ${p.rebajado > 0 ? `<p class="text-sm line-through text-gray-400 leading-none">${CONFIG.currency}${p.precio}</p>` : ''}
                            <p class="text-3xl font-black text-gray-900">${CONFIG.currency}${p.rebajado > 0 ? p.rebajado : p.precio}</p>
                        </div>
                        <button onclick="addToCart('${encodeURIComponent(JSON.stringify(p))}')" class="px-8 py-3 bg-[var(--primary)] text-white font-bold rounded-xl shadow-lg">A√±adir</button>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('modal-active');
            lucide.createIcons();
        }

        function closeModal() {
            const modal = document.getElementById('product-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('modal-active');
        }

        // --- NAVEGACI√ìN ---
        function setCategory(cat) {
            activeCategory = cat;
            renderCategories();
            filterProducts();
        }

        function changePage(delta) {
            currentPage += delta;
            renderProducts();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        document.getElementById('search').addEventListener('input', filterProducts);

        // Iniciar
        loadData();
    </script>
</body>
</html>
